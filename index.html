<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Sys-Ualas PDV v5.0</title>

<meta name="theme-color" content="#1e3a8a">
<link rel="manifest" href="manifest.json">

<script src="https://unpkg.com/dexie/dist/dexie.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,sans-serif;background:#f3f4f6}
.hidden{display:none}
.screen{display:none;padding:15px}
.screen.active{display:block}
.navbar{height:60px;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 15px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.nav-btn{padding:10px;border:none;border-radius:6px;font-weight:600;cursor:pointer}
.primary{background:#1e3a8a;color:#fff}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:10px}
input,select{width:100%;padding:10px;margin-top:5px;font-size:16px}

@media print{
body *{visibility:hidden}
#printArea,#printArea *{visibility:visible}
#printArea{position:absolute;top:0;left:0;width:100%}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="screen-login" class="screen active">
  <div class="card">
    <h2>SYS-UALAS PDV</h2>
    <input id="loginUser" placeholder="Usuário">
    <input id="loginPass" type="password" placeholder="Senha">
    <button class="nav-btn primary" onclick="login()">Entrar</button>
    <div id="loginError" style="color:red;display:none">Acesso negado</div>
  </div>
</div>

<!-- PDV -->
<div id="screen-pdv" class="screen">
  <div class="card">
    <label>Vendedor</label>
    <input id="vendedor">
  </div>

  <div class="card">
    <input id="busca" placeholder="Buscar produto">
    <div id="resultado"></div>
  </div>

  <div class="card">
    <h3>Cupom</h3>
    <div id="cart"></div>
    <b>Total: R$ <span id="total">0.00</span></b>
    <button class="nav-btn primary" onclick="finalizarVenda()">Finalizar</button>
  </div>
</div>

<div id="printArea"></div>

<script>
/* ================= BANCO ================= */
const db = new Dexie("PDV_DB_V5");
db.version(1).stores({
  usuarios:'login',
  produtos:'codigo,descricao',
  vendas:'id,data',
  logs:'++id,tipo,data'
});

/* ================= UTIL ================= */
async function hash(txt){
  const b = new TextEncoder().encode(txt);
  const h = await crypto.subtle.digest("SHA-256",b);
  return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,'0')).join('');
}
function log(tipo,info){
  db.logs.add({tipo,info,data:new Date()});
}
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ================= ESTADO ================= */
let user=null;
let venda={
  id:null,
  vendedor:'',
  itens:[],
  total:0
};

/* ================= INIT ================= */
(async()=>{
  await db.open();
  if(await db.usuarios.count()==0){
    await db.usuarios.add({login:'ADMIN',senha:await hash('123')});
  }
})();

/* ================= LOGIN ================= */
async function login(){
  const u=document.getElementById('loginUser').value.toUpperCase();
  const s=await hash(document.getElementById('loginPass').value);
  const usr=await db.usuarios.get(u);
  if(usr && usr.senha===s){
    user=usr;
    document.getElementById('vendedor').value=u;
    show('screen-pdv');
    log('LOGIN',u);
  }else{
    document.getElementById('loginError').style.display='block';
  }
}

/* ================= BUSCA ================= */
document.getElementById('busca').addEventListener('input',async e=>{
  const t=e.target.value.toUpperCase();
  if(t.length<2)return;
  const r=await db.produtos.where('descricao').startsWith(t).limit(5).toArray();
  document.getElementById('resultado').innerHTML=
    r.map(p=>`<div onclick='addItem(${JSON.stringify(p)})'>${p.descricao}</div>`).join('');
});

/* ================= CARRINHO ================= */
function addItem(p){
  venda.itens.push({...p,qtd:1});
  render();
}
function render(){
  let t=0;
  document.getElementById('cart').innerHTML=venda.itens.map(i=>{
    t+=i.preco*i.qtd;
    return `<div>${i.descricao} - R$ ${i.preco}</div>`;
  }).join('');
  venda.total=t;
  document.getElementById('total').innerText=t.toFixed(2);
}

/* ================= FINALIZAR ================= */
async function finalizarVenda(){
  if(!venda.itens.length)return alert("Carrinho vazio");
  try{
    venda.id=crypto.randomUUID();
    venda.data=new Date();
    venda.vendedor=document.getElementById('vendedor').value;
    await db.vendas.add({...venda});
    log('VENDA_OK',venda.id);
    imprimir(venda);
    venda={itens:[],total:0};
    render();
  }catch(e){
    log('ERRO_VENDA',e.message);
    alert("Erro ao salvar venda");
  }
}

/* ================= IMPRESSÃO TEXTO PURO ================= */
function imprimir(v){
  let txt="*** CUPOM ***\n";
  txt+="Vendedor: "+v.vendedor+"\n\n";
  v.itens.forEach(i=>{
    txt+=`${i.descricao}  ${i.qtd}x ${i.preco.toFixed(2)}\n`;
  });
  txt+="----------------\n";
  txt+="TOTAL: R$ "+v.total.toFixed(2);
  document.getElementById('printArea').innerText=txt;
  window.print();
}

/* ================= PWA ================= */
if('serviceWorker'in navigator){
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
