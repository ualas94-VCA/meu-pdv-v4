	<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sys-Ualas PDV v4.1 (Conectado)</title>
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ============================================================
           1. ESTILOS VISUAIS (INTERFACE)
           ============================================================ */
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* LOGIN */
        #screen-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #3b82f6 100%); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { position: relative; z-index: 10; background: rgba(255, 255, 255, 0.95); padding: 50px 40px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); width: 100%; max-width: 420px; text-align: center; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); }
        .brand-title { font-size: 2rem; font-weight: 800; color: #1e3a8a; margin: 0; letter-spacing: -1px; text-transform: uppercase; }
        .brand-subtitle { font-size: 0.9rem; color: #64748b; margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase; font-weight: 600; }
        
        .login-input { width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; color: #334155; background-color: #f8fafc; text-transform: uppercase; margin-bottom: 15px; }
        .login-btn { width: 100%; padding: 15px; background: linear-gradient(to right, #1e3a8a, #2563eb); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .login-error { background: #fef2f2; color: #dc2626; padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9em; display: none; }

        /* NAVBAR */
        .navbar { background-color: #ffffff; height: 65px; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); z-index: 100; }
        .brand { font-size: 1.3rem; font-weight: 800; color: #1e3a8a; display: flex; align-items: center; gap: 10px; }
        .user-info { font-size: 0.9em; color: #64748b; margin-right: 15px; font-weight: 600; }
        .nav-btn { background: #f1f5f9; color: #475569; border: none; padding: 9px 18px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9em; margin-left: 8px; }
        .nav-btn:hover { background: #e2e8f0; color: #1e293b; }
        .nav-btn.active { background: #1e3a8a; color: white; box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.3); }
        .btn-logout { background: #fef2f2; color: #ef4444; }

        /* LAYOUT */
        .screen { display: none; height: calc(100vh - 65px); padding: 20px; overflow-y: auto; }
        .screen.active { display: flex; } 
        #screen-pdv { gap: 20px; }
        .left-panel { flex: 1.8; display: flex; flex-direction: column; gap: 20px; }
        .right-panel { flex: 1; width: 380px; min-width: 350px; background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; border: 1px solid #f1f5f9; }
        .card-pdv { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
        
        .input-group { margin-bottom: 15px; }
        .input-control { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; outline: none; transition: 0.2s; color: #334155; }
        #inputVendedora { background-color: #eff6ff; border-color: #bfdbfe; font-weight: bold; color: #1d4ed8; }

        .price-toggle { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 2px solid #cbd5e1; font-weight: 700; cursor: pointer; background: #f8fafc; color: #64748b; transition: 0.2s; }
        .price-toggle.active-p2 { background: #0ea5e9; color: white; border-color: #0284c7; }

        #searchResult { max-height: 300px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; margin-top: 5px; display: none; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); position: relative; z-index: 50; }
        .search-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.1s; }
        .search-item:hover, .search-item.selected { background: #eff6ff; }

        #cartList { flex: 1; overflow-y: auto; border-top: 2px dashed #e2e8f0; padding-top: 15px; margin-top: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .btn-remove { color: #ef4444; background: #fef2f2; width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; }

        .financial-area { background: #f8fafc; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; margin-top: auto; }
        .fin-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9em; color: #64748b; font-weight: 500; }
        .fin-total { font-size: 2rem; font-weight: 800; color: #166534; text-align: right; border-top: 2px dashed #cbd5e1; padding-top: 10px; margin-top: 10px; letter-spacing: -1px; }
        .discount-inputs { display: flex; gap: 5px; }
        .input-mini { padding: 5px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9em; text-align: right; }

        #divTroco { background: #fff7ed; padding: 12px; border-radius: 8px; border: 1px solid #ffedd5; margin-top: 10px; display: none; }
        .troco-val { font-size: 1.2em; font-weight: 800; color: #c2410c; }
        .btn-finalize { width: 100%; padding: 16px; background: linear-gradient(to right, #16a34a, #15803d); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 700; cursor: pointer; margin-top: 15px; }

        #screen-dashboard, #screen-config { flex-direction: column; gap: 20px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .kpi-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .kpi-val { font-size: 2em; font-weight: 800; color: #1e293b; }
        .table-card, .config-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 15px; background: #f8fafc; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        
        .config-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-imp { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .btn-danger { background: #fef2f2; color: #dc2626; border: 1px solid #fca5a5; }

        /* ============================================================
           2. ESTILO DE IMPRESSÃO (TEXTO PURO)
           Focado em impressoras térmicas 80mm com margens ajustadas.
           ============================================================ */
        #printArea { display: none; }

        @media print {
            @page { margin: 0; size: auto; }
            html, body { margin: 0 !important; padding: 0 !important; background-color: #fff !important; width: 100% !important; }
            body > *:not(#printArea) { display: none !important; }
            #printArea, #printArea * { visibility: visible; display: block; }
            
            #printArea {
                position: absolute; top: 0; left: 0; width: 100%; padding: 0; margin: 0;
            }

            /* Configuração da TAG PRE para simular impressora matricial/térmica */
            #cupom-content {
                font-family: 'Courier New', 'Lucida Console', monospace; 
                font-size: 16px; /* Tamanho físico para leitura */
                font-weight: 800; /* Negrito para contraste */
                white-space: pre; /* Respeita espaços */
                width: 100%;
                margin: 0;
                line-height: 1.0; 
                color: black;
            }
        }
/* --- INÍCIO DA ÁREA SEGURA PARA MOBILE --- */
@media (max-width: 768px) {
    /* 1. Organiza os blocos principais para empilharem em vez de espremer */
    #screen-pdv, .container-principal { 
        display: flex !important;
        flex-direction: column !important;
        padding: 5px !important;
    }

    /* 2. Ajusta as colunas de Vendedora, Loja, Cliente e CPF */
    /* Aqui usamos 'flex: 1 1 100%' para que cada campo ocupe sua própria linha no celular */
    .vendedora-loja, .dados-cliente {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 10px !important;
    }

    .vendedora-loja > div, .dados-cliente > div {
        flex: 1 1 100% !important; /* Força 100% de largura no celular */
    }

    /* 3. Melhora o tamanho dos inputs para o toque do dedo, sem mudar a função */
    input, select, button {
        height: 48px !important; /* Tamanho padrão de acessibilidade mobile */
        font-size: 16px !important; /* Impede o zoom involuntário do navegador */
    }

    /* 4. Garante que o Cupom fique visível abaixo dos campos de inserção */
    #cupom-fiscal {
        width: 100% !important;
        margin: 20px 0 !important;
        order: 2; /* Garante que ele apareça depois dos produtos */
    }
}
/* --- FIM DA ÁREA SEGURA --- */
    </style>
</head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="theme-color" content="#007bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="manifest" href="manifest.json">
<body>

    <div id="screen-login">
        <div class="login-box">
            <h1 class="brand-title">SYS-UALAS</h1>
            <p class="brand-subtitle">PDV v4.1 Conectado</p>
            <div class="login-input-group">
                <input type="text" id="loginUser" class="login-input" placeholder="USUÁRIO (Ex: UALAS)" autocomplete="off">
            </div>
            <div class="login-input-group">
                <input type="password" id="loginPass" class="login-input" placeholder="SENHA" onkeyup="if(event.key==='Enter') fazerLogin()">
            </div>
            <div id="loginError" class="login-error">Credenciais inválidas!</div>
            <button class="login-btn" onclick="fazerLogin()">ACESSAR SISTEMA</button>
        </div>
    </div>

    <div class="navbar no-print">
        <div class="brand"><i class="fas fa-cash-register"></i> Sys-Ualas v4.1</div>
        <div style="display:flex; align-items:center;">
            <div class="user-info"><i class="fas fa-user-circle"></i> <span id="lblUser">...</span></div>
            <div style="display:flex;">
                <button class="nav-btn active" onclick="showScreen('pdv')" id="nav-pdv"><i class="fas fa-shopping-cart"></i> VENDAS</button>
                <button class="nav-btn" onclick="showScreen('dashboard')" id="nav-dashboard"><i class="fas fa-chart-pie"></i> GESTÃO</button>
                <button class="nav-btn" onclick="showScreen('config')" id="nav-config"><i class="fas fa-cog"></i> CONFIG</button>
                <button class="nav-btn btn-logout" onclick="logout()" style="margin-left:15px;"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </div>

    <div id="screen-pdv" class="screen no-print">
        <div class="left-panel">
            <div class="card-pdv">
                <div style="display:flex; gap:15px;">
                    <div class="input-group" style="flex:1;">
                        <label>VENDEDORA</label>
                        <input type="text" id="inputVendedora" class="input-control">
                    </div>
                    <div class="input-group" style="flex:1;">
                        <label>LOJA</label>
                        <select id="selLoja" class="input-control">
                            <option>KIDS CENTRO</option><option>KIDS OLIVIA</option>
                            <option>BLESS CENTRO</option><option>BLESS OLIVIA</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:15px;">
                    <div class="input-group" style="flex:2;">
                        <label>CLIENTE</label>
                        <input type="text" id="cliNome" class="input-control" placeholder="Nome">
                    </div>
                    <div class="input-group" style="flex:1;">
                        <label>TEL</label>
                        <input type="text" id="cliTel" class="input-control" placeholder="(XX) 9...">
                    </div>
                </div>
                <div class="input-group"><label>CPF</label><input type="text" id="cliCpf" class="input-control" placeholder="000..."></div>
            </div>

            <div class="card-pdv" style="flex:1; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; color:#1e3a8a;"><i class="fas fa-barcode"></i> PRODUTOS</h3>
                    <small id="dbCount" style="color:#16a34a; font-weight:700;">...</small>
                </div>
                <button id="btnPriceToggle" class="price-toggle" onclick="togglePreco()">TABELA: PREÇO 1</button>
                <div style="position: relative;">
                    <input type="text" id="searchInput" class="input-control" placeholder="Código ou Nome..." autocomplete="off" style="font-size: 1.1em; text-transform:uppercase;">
                    <div id="searchResult"></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <h3 style="margin:0; padding-bottom:10px; border-bottom:1px solid #e2e8f0; color:#1e3a8a;">CUPOM</h3>
            <div id="cartList"><div style="text-align:center; margin-top:50px; color:#cbd5e1;">Vazio</div></div>

            <div class="financial-area">
                <div class="fin-row"><span>Subtotal</span><strong id="lblSubtotal">R$ 0,00</strong></div>
                <div class="fin-row">
                    <span>Desconto</span>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="inputDesconto" class="input-control" style="padding:5px; height:30px; width:70px; text-align:right;" placeholder="0" oninput="calcTotals()">
                        <select id="tipoDesconto" class="input-control" style="padding:0; height:30px; width:50px;" onchange="calcTotals()"><option value="%">%</option><option value="R$">R$</option></select>
                    </div>
                </div>
                <div class="fin-total">R$ <span id="lblTotalFinal">0,00</span></div>
            </div>

            <div style="margin-top:10px;">
                <label style="font-size:0.7em; font-weight:700; color:#64748b;">PAGAMENTO</label>
                <select id="selPagamento" class="input-control" style="font-weight:bold; margin-top:5px;" onchange="checkMoney()">
                    <option value="DINHEIRO">DINHEIRO</option><option value="PIX">PIX</option><option value="CARTAO DE CREDITO">CARTÃO DE CRÉDITO</option><option value="CARTAO DE DEBITO">CARTÃO DE DÉBITO</option>
                    <option value="CARTAO VIA LINK">CARTÃO VIA LINK</option><option value="PROMISSORIA">PROMISSÓRIA</option><option value="CONDICIONAL">CONDICIONAL</option>
                </select>
            </div>

            <div id="divTroco" style="display:none; background:#fff7ed; padding:10px; border-radius:8px; border:1px solid #ffedd5; margin-top:10px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <div style="flex:1;"><label style="font-size:0.7em; font-weight:700; color:#c2410c;">RECEBIDO</label><input type="number" id="inputRecebido" class="input-control" placeholder="R$ 0,00" oninput="calcChange()"></div>
                    <div style="flex:1; text-align:right;"><label style="font-size:0.7em; font-weight:700; color:#c2410c;">TROCO</label><div class="troco-val" id="lblTroco">R$ 0,00</div></div>
                </div>
            </div>
            <button class="btn-finalize" onclick="finalizarVenda()">FINALIZAR (F5)</button>
        </div>
    </div>

    <div id="screen-dashboard" class="screen no-print">
        <h2 style="color:#1e3a8a;">Visão Geral</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="nav-btn" onclick="loadDashboard()"><i class="fas fa-sync"></i> Atualizar</button>
            <button class="nav-btn" style="background:#7c3aed; color:white;" onclick="exportarJson()"><i class="fas fa-cloud-upload-alt"></i> Baixar JSON</button>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-val" id="kpiTotal">R$ 0,00</div><div style="color:#64748b;">Vendas Hoje</div></div>
            <div class="kpi-card"><div class="kpi-val" id="kpiPedidos">0</div><div style="color:#64748b;">Pedidos</div></div>
        </div>
        <div class="table-card" style="margin-top:20px;">
            <h3 style="margin:0 0 15px 0;">Vendas Recentes</h3>
            <table><thead><tr><th>Hora</th><th>Vend</th><th>Total</th><th>Status</th><th>Ações</th></tr></thead><tbody id="dashTableBody"></tbody></table>
        </div>
    </div>

    <div id="screen-config" class="screen no-print">
        <h2 style="color:#1e3a8a;">Configurações</h2>
        
        <div class="config-card">
            <h3><i class="fas fa-cloud-download-alt"></i> Sincronização em Nuvem</h3>
            <p style="color:#666; font-size:0.9em; margin-bottom:10px;">Cole o link direto do CSV (Ex: Google Sheets Publicado na Web)</p>
            <div style="display:flex; gap:10px;">
                <input type="text" id="urlCsv" class="input-control" placeholder="https://docs.google.com/spreadsheets/..." value="">
                <button class="config-btn btn-imp" style="margin-top:0; width:auto; white-space:nowrap;" onclick="importarViaLink()">BAIXAR DA NUVEM</button>
            </div>
        </div>

        <div class="config-card" style="margin-top:20px;">
            <h3><i class="fas fa-database"></i> Arquivo Local</h3>
            <input type="file" id="fileInput" accept=".csv" class="input-control" style="margin-top:10px;">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="config-btn btn-imp" onclick="processarArquivoInput()">IMPORTAR ARQUIVO</button>
                <button class="config-btn btn-danger" onclick="zerarBanco()">ZERAR DADOS</button>
            </div>
        </div>

        <div class="config-card" style="margin-top:20px;">
            <h3><i class="fas fa-users"></i> Usuários</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="newUserName" class="input-control" placeholder="Nome">
                <input type="text" id="newUserPass" class="input-control" placeholder="Senha">
                <select id="newUserRole" class="input-control"><option value="vendedor">Vendedor</option><option value="admin">Admin</option></select>
                <button class="nav-btn active" onclick="addUser()"><i class="fas fa-plus"></i></button>
            </div>
            <div id="userList" style="border:1px solid #eee; padding:10px; border-radius:8px;"></div>
        </div>
    </div>

    <div id="printArea"></div>

    <script>
        // --- 1. BANCO DE DADOS (Dexie.js) ---
        const db = new Dexie("PDV_Contingencia_DB");
        db.version(3).stores({
            usuarios: '++id, login', 
            produtos: 'codigo, descricao, preco, preco2, categoria', 
            vendas: 'id, data, status_sinc',
            logs: '++id, data'
        });

        // --- 2. VARIÁVEIS GLOBAIS ---
        let cart = [], usarPreco2 = false, searchResultsCache = [], selectedIndex = -1, currentUser = null; 
        let globalSubtotal = 0, globalTotalFinal = 0;

        // --- 3. INICIALIZAÇÃO ---
        async function init() {
            try {
                if(!db.isOpen()) await db.open();
                if(await db.usuarios.count() === 0) {
                    await db.usuarios.add({ login: 'ADMIN', senha: '123', perfil: 'admin' });
                    await db.usuarios.add({ login: 'UALAS', senha: '123', perfil: 'admin' });
                    await db.usuarios.add({ login: 'VENDEDOR', senha: '123', perfil: 'vendedor' });
                }
                carregarListaUsuariosConfig(); atualizarStatus();
                // Recupera URL salva se houver
                const savedUrl = localStorage.getItem('csvUrl');
                if(savedUrl) document.getElementById('urlCsv').value = savedUrl;
                
                document.getElementById('loginUser').focus();
            } catch (e) { console.error(e); }
        }
        init();

        // --- 4. LOGIN ---
        async function fazerLogin() {
            const login = document.getElementById('loginUser').value.trim().toUpperCase();
            const pass = document.getElementById('loginPass').value;
            if(!login) return;
            const user = await db.usuarios.where('login').equals(login).first();
            if(user && user.senha === pass) {
                currentUser = user;
                registrarLog(user.login, 'LOGIN');
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('lblUser').innerText = user.login;
                document.getElementById('inputVendedora').value = user.login;
                document.getElementById('loginError').style.display = 'none';
                if(user.perfil === 'vendedor') {
                    document.getElementById('nav-dashboard').style.display = 'none';
                    document.getElementById('nav-config').style.display = 'none';
                    showScreen('pdv');
                } else {
                    document.getElementById('nav-dashboard').style.display = 'flex';
                    document.getElementById('nav-config').style.display = 'flex';
                    showScreen('pdv');
                }
            } else { document.getElementById('loginError').style.display = 'block'; }
        }
        function logout() { location.reload(); }

        // --- 5. NAVEGAÇÃO ---
        function showScreen(name) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`screen-${name}`).classList.add('active');
            const btn = document.getElementById(`nav-${name}`); if(btn) btn.classList.add('active');
            if(name === 'pdv') document.getElementById('searchInput').focus();
            if(name === 'dashboard') loadDashboard();
            if(name === 'config') atualizarStatus();
        }

        // --- 6. PDV ---
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('keyup', async (e) => {
            if (['ArrowDown','ArrowUp','Enter'].includes(e.key)) { handleNav(e.key); return; }
            const term = e.target.value.trim();
            if (term.length < 2) { document.getElementById('searchResult').style.display = 'none'; return; }
            let prods = [];
            if (/^\d+$/.test(term)) prods = await db.produtos.where('codigo').startsWith(term).limit(15).toArray();
            else prods = await db.produtos.where('descricao').startsWithIgnoreCase(term).limit(15).toArray();
            searchResultsCache = prods;
            renderSearch(prods);
        });

        function renderSearch(lista) {
            const res = document.getElementById('searchResult'); res.innerHTML = '';
            if(!lista.length) { res.style.display = 'none'; return; }
            lista.forEach((p, idx) => {
                const p1 = p.preco || 0; const p2 = p.preco2 || p1; 
                const styleP1 = !usarPreco2 ? 'color:#16a34a; font-weight:bold;' : 'color:#9ca3af; font-size:0.9em;';
                const styleP2 = usarPreco2 ? 'color:#0284c7; font-weight:bold;' : 'color:#9ca3af; font-size:0.9em;';
                const div = document.createElement('div'); div.className = 'search-item';
                div.innerHTML = `<div style="flex:1;"><strong>${p.codigo}</strong> ${p.descricao.replace('(MEMO)','')}</div>
                                 <div style="text-align:right;"><div style="${styleP1}">R$ ${p1.toFixed(2)}</div><div style="${styleP2}">R$ ${p2.toFixed(2)}</div></div>`;
                div.onclick = () => addToCart(p);
                res.appendChild(div);
            });
            res.style.display = 'block'; selectedIndex = -1;
        }

        function handleNav(key) {
            const items = document.querySelectorAll('.search-item');
            if(key === 'Enter') {
                if(selectedIndex >= 0 && items[selectedIndex]) items[selectedIndex].click();
                else if(searchResultsCache.length > 0) addToCart(searchResultsCache[0]);
            }
            if(key === 'ArrowDown') selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            if(key === 'ArrowUp') selectedIndex = Math.max(selectedIndex - 1, 0);
            if(items[selectedIndex]) { items.forEach(i=>i.classList.remove('selected')); items[selectedIndex].classList.add('selected'); items[selectedIndex].scrollIntoView({block:'nearest'}); }
        }

        function addToCart(p) {
            const ex = cart.find(i => i.codigo === p.codigo);
            if(ex) ex.qtd++; 
            else {
                cart.push({ 
                    ...p, qtd: 1, nome: p.descricao.replace('(MEMO)',''),
                    preco: Number(p.preco) || 0,
                    preco2: Number(p.preco2) || Number(p.preco) || 0 
                });
            }
            updateCart();
            searchInput.value = ''; document.getElementById('searchResult').style.display = 'none'; searchInput.focus();
        }

        function updateCart() {
            const list = document.getElementById('cartList'); list.innerHTML = '';
            let total = 0;
            cart.forEach((item, idx) => {
                const p = usarPreco2 ? item.preco2 : item.preco;
                const sub = item.qtd * p; total += sub;
                const div = document.createElement('div'); div.className = 'cart-item';
                div.innerHTML = `<div style="flex:1;"><div style="font-weight:bold;">${item.nome}</div><small>${item.qtd}x R$ ${p.toFixed(2)}</small></div>
                                 <div style="font-weight:bold; margin-right:10px;">R$ ${sub.toFixed(2)}</div>
                                 <button class="btn-remove" onclick="cart.splice(${idx},1); updateCart();"><i class="fas fa-times"></i></button>`;
                list.appendChild(div);
            });
            globalSubtotal = total;
            calcTotals();
        }

        function togglePreco() {
            usarPreco2 = !usarPreco2; const btn = document.getElementById('btnPriceToggle');
            if(usarPreco2) { btn.innerText = "TABELA: PREÇO 2"; btn.classList.add('active-p2'); } else { btn.innerText = "TABELA: PREÇO 1"; btn.classList.remove('active-p2'); }
            updateCart(); searchInput.focus();
        }

        // --- 7. CÁLCULOS ---
        function calcTotals() {
            const inputDesc = parseFloat(document.getElementById('inputDesconto').value) || 0;
            const type = document.getElementById('tipoDesconto').value;
            let vlrDesc = (type === '%') ? globalSubtotal * (inputDesc/100) : inputDesc;
            globalTotalFinal = Math.max(0, globalSubtotal - vlrDesc);
            document.getElementById('lblSubtotal').innerText = globalSubtotal.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
            document.getElementById('lblTotalFinal').innerText = globalTotalFinal.toLocaleString('pt-BR',{minimumFractionDigits:2});
            calcChange();
        }

        function checkMoney() {
            const pgto = document.getElementById('selPagamento').value;
            const div = document.getElementById('divTroco');
            div.style.display = (pgto === 'DINHEIRO') ? 'block' : 'none';
            if(pgto === 'DINHEIRO') document.getElementById('inputRecebido').focus();
        }

        function calcChange() {
            if(document.getElementById('selPagamento').value !== 'DINHEIRO') return;
            const rec = parseFloat(document.getElementById('inputRecebido').value) || 0;
            const troco = rec - globalTotalFinal;
            const el = document.getElementById('lblTroco');
            el.innerText = troco.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
            el.style.color = troco < 0 ? 'red' : '#16a34a';
        }

        // --- 8. FINALIZAR ---
        async function finalizarVenda() {
            if(!cart.length) return alert("Carrinho vazio!");
            const vendedoraNome = document.getElementById('inputVendedora').value.trim().toUpperCase();
            if(!vendedoraNome) return alert("Preencha a Vendedora!");
            const pgto = document.getElementById('selPagamento').value;
            let rec = 0, troco = 0;
            if(pgto === 'DINHEIRO') {
                rec = parseFloat(document.getElementById('inputRecebido').value) || 0;
                troco = rec - globalTotalFinal;
                if(troco < -0.01 && rec > 0) {
                    if(!confirm("Valor recebido menor que o total. Continuar?")) return;
                }
            }
            const id = "P" + Math.floor(Date.now() / 1000);
            const venda = {
                id, data: new Date(), 
                loja: document.getElementById('selLoja').value, 
                vendedora: vendedoraNome,
                cliente: document.getElementById('cliNome').value, cpf: document.getElementById('cliCpf').value, tel: document.getElementById('cliTel').value,
                itens: cart, 
                subtotal: globalSubtotal, total: globalTotalFinal, desconto: globalSubtotal - globalTotalFinal,
                tabela: usarPreco2 ? 'PREÇO 2' : 'PREÇO 1', 
                pagamento: pgto, recebido: rec, troco: troco,
                status_sinc: 'pendente'
            };
            try {
                await db.vendas.add(venda);
                registrarLog(currentUser ? currentUser.login : 'SYS', 'VENDA', `ID: ${id}`);
                imprimir(venda);
                cart = []; 
                document.getElementById('inputDesconto').value = '';
                document.getElementById('inputRecebido').value = '';
                document.getElementById('cliNome').value = '';
                updateCart(); 
                atualizarStatus();
            } catch (e) { alert("Erro ao salvar: " + e); }
        }

        async function imprimirID(id) { const v = await db.vendas.get(id); imprimir(v); }
        
        // --- 9. GERADOR DE CUPOM TEXTO PURO ---
        function gerarCupomTexto(venda) {
            const LARGURA = 40; 
            const centro = (str) => {
                const espacos = Math.max(0, LARGURA - str.length);
                const esq = Math.floor(espacos / 2);
                return " ".repeat(esq) + str; 
            };
            const linha = (char = "-") => char.repeat(LARGURA);
            const par = (label, valor) => {
                const valStr = String(valor);
                const espacos = Math.max(0, LARGURA - label.length - valStr.length);
                return label + " ".repeat(espacos) + valStr;
            };
            const money = (val) => "R$ " + parseFloat(val).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            let txt = "";
            txt += centro(venda.loja) + "\n";
            txt += centro("CONTINGENCIA (OFFLINE)") + "\n";
            txt += linha() + "\n";
            txt += `DATA: ${venda.data.toLocaleString('pt-BR')}\n`;
            txt += `VEND: ${venda.vendedora.toUpperCase()}\n`;
            txt += linha() + "\n";
            txt += `CLI : ${venda.cliente || 'CONSUMIDOR'}\n`;
            if(venda.cpf) txt += `CPF : ${venda.cpf}\n`;
            txt += linha() + "\n";
            txt += "COD   DESCRICAO           QTD      TOTAL\n";
            txt += linha() + "\n";

            venda.itens.forEach(item => {
                const p = (venda.tabela === 'PREÇO 2') ? item.preco2 : item.preco;
                const totalItem = item.qtd * (p || 0);
                let sCod = item.codigo.substring(0, 5).padEnd(5, " ");
                let sDesc = item.nome.substring(0, 19).padEnd(19, " "); 
                let sQtd = String(item.qtd).padStart(3, " ");
                let sVal = totalItem.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).padStart(10, " ");
                txt += `${sCod} ${sDesc} ${sQtd} ${sVal}\n`;
                if (item.nome.length > 19) txt += "      " + item.nome.substring(19, 50) + "\n";
            });

            txt += linha() + "\n";
            txt += par("SUBTOTAL:", money(venda.subtotal)) + "\n";
            if (venda.desconto > 0) txt += par("DESCONTO:", "-" + money(venda.desconto)) + "\n";
            txt += "\n"; 
            txt += linha("=") + "\n"; 
            txt += par("TOTAL A PAGAR:", money(venda.total)) + "\n"; 
            txt += linha("=") + "\n"; 
            txt += par("FORMA PAGTO:", venda.pagamento) + "\n";
            if (venda.pagamento === 'DINHEIRO' && venda.recebido > 0) {
                txt += par("RECEBIDO:", money(venda.recebido)) + "\n";
                txt += par("TROCO:", money(venda.troco)) + "\n";
            }
            txt += linha() + "\n";
            txt += centro("OBRIGADO PELA PREFERENCIA") + "\n";
            txt += centro("Sys-Ualas v4.1") + "\n\n\n"; 
            return txt;
        }

        function imprimir(v) {
            const textoCupom = gerarCupomTexto(v);
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = `<pre id="cupom-content">${textoCupom}</pre>`;
            setTimeout(() => { window.print(); }, 250);
        }

        // --- 10. IMPORTAÇÃO E DADOS ---
        // Função unificada de processamento de CSV
        async function importarDados(csvText) {
            const lines = csvText.split('\n');
            let imp = [];
            for(let i=0; i<lines.length; i++) {
                const line = lines[i].trim();
                if(!line) continue;
                const cols = line.split(';');
                if(cols.length >= 3 && !cols[0].toLowerCase().includes('codigo')) {
                    // Conversão segura de moeda brasileira
                    let p1 = parseFloat(cols[2].replace('R$','').replace('.','').replace(',','.')) || 0;
                    let p2 = cols[3] ? parseFloat(cols[3].replace('R$','').replace('.','').replace(',','.')) : p1;
                    
                    imp.push({
                        codigo: cols[0].trim(),
                        descricao: cols[1].trim(),
                        preco: p1,
                        preco2: p2,
                        categoria: 'Geral'
                    });
                }
            }
            
            if(imp.length > 0) {
                await db.produtos.clear();
                await db.produtos.bulkPut(imp);
                registrarLog(currentUser ? currentUser.login : 'SYS', 'IMPORT', `${imp.length} itens importados`);
                alert(`Sucesso! ${imp.length} produtos carregados.`);
                atualizarStatus();
            } else {
                alert("Erro: Nenhum produto encontrado ou formato inválido.");
            }
        }

        // Importação via Arquivo Local
        function processarArquivoInput() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return alert("Selecione um arquivo CSV!");
            const reader = new FileReader();
            reader.onload = async (e) => {
                await importarDados(e.target.result);
            };
            reader.readAsText(file, "ISO-8859-1");
        }

        // Importação via Link (Nova v4.1)
        async function importarViaLink() {
            const url = document.getElementById('urlCsv').value;
            if(!url) return alert("Cole um link válido!");
            
            // Salva URL para próxima vez
            localStorage.setItem('csvUrl', url);
            
            try {
                const response = await fetch(url);
                if(!response.ok) throw new Error("Erro ao acessar link");
                const text = await response.text();
                await importarDados(text);
            } catch (e) {
                alert("Falha ao baixar do link: " + e.message + "\nVerifique se o link é público.");
            }
        }

        // Outros utilitários
        async function loadDashboard() {
            const start = new Date(new Date().setHours(0,0,0,0));
            const vendas = await db.vendas.where('data').above(start).reverse().toArray();
            const total = vendas.reduce((acc,v)=>acc+v.total,0);
            document.getElementById('kpiTotal').innerText = total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('kpiPedidos').innerText = vendas.length;
            const t = document.getElementById('dashTableBody'); t.innerHTML = '';
            vendas.forEach(v => { t.innerHTML += `<tr><td>${v.data.toLocaleTimeString().substring(0,5)}</td><td>${v.vendedora}</td><td style="color:green;">R$ ${v.total.toFixed(2)}</td><td>${v.status_sinc}</td><td><button onclick="imprimirID('${v.id}')"><i class="fas fa-print"></i></button></td></tr>`; });
        }
        
        async function registrarLog(u, a, d='') { await db.logs.add({ data: new Date(), usuario: u, acao: a, detalhes: d }); }
        async function carregarLogs() { const logs = await db.logs.reverse().limit(50).toArray(); document.getElementById('logTableBody').innerHTML = logs.map(l => `<tr><td>${l.data.toLocaleTimeString()}</td><td>${l.usuario}</td><td>${l.acao}</td></tr>`).join(''); }
        async function addUser() { const l=document.getElementById('newUserName').value.toUpperCase(); const s=document.getElementById('newUserPass').value; if(l&&s){ await db.usuarios.add({login:l, senha:s, perfil:document.getElementById('newUserRole').value}); carregarListaUsuariosConfig(); } }
        async function carregarListaUsuariosConfig() { const u=await db.usuarios.toArray(); document.getElementById('userList').innerHTML=u.map(x=>`<div style="border-bottom:1px solid #eee; padding:5px;">${x.login} (${x.perfil}) <i class="fas fa-trash" style="color:red; float:right; cursor:pointer;" onclick="removeUser(${x.id})"></i></div>`).join(''); }
        async function removeUser(id) { if(confirm("Apagar?")) { await db.usuarios.delete(id); carregarListaUsuariosConfig(); } }
        async function zerarBanco() { if(confirm("Apagar tudo?")) { await db.produtos.clear(); await db.vendas.clear(); alert("Limpo!"); atualizarStatus(); } }
        async function atualizarStatus() { document.getElementById('dbCount').innerText = (await db.produtos.count()) + " Itens"; }
        async function exportarJson() { const p=await db.vendas.where('status_sinc').equals('pendente').toArray(); if(!p.length)return alert("Nada pendente"); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(p)],{type:"application/json"})); a.download="vendas.json"; a.click(); if(confirm("Sincronizado?")){ await db.vendas.where('status_sinc').equals('pendente').modify({status_sinc:'sincronizado'}); loadDashboard(); }}

        document.addEventListener('keydown', (e) => {
            if(!currentUser) return; 
            if(e.key === 'F1') { e.preventDefault(); showScreen('pdv'); }
            if(e.key === 'F2' && currentUser.perfil === 'admin') { e.preventDefault(); showScreen('dashboard'); }
            if(e.key === 'F3' && currentUser.perfil === 'admin') { e.preventDefault(); showScreen('config'); }
            if(e.key === 'F5' && document.getElementById('screen-pdv').classList.contains('active')) { e.preventDefault(); finalizarVenda(); }
        });
    </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('PWA: Sistema Offline Ativo!'))
        .catch(err => console.log('PWA: Erro ao configurar offline', err));
    });
  }
</script>

</body>
</html>
